#!/bin/bash
#
# Example usage of strings
# strings -e l /var/vmware/datarecovery/operations_log.utx | grep -i -B2 "error" | awk -F"$" '{print "[1: " $1 "] [2: " $2 "] [3: " $3 "] [4: " $4 "] [5: " $5 "] [6: " $6 "] [7: " $7 "] [8: " $8 "] [9: " $9 "]"}'
# Link: http://www.sheenaustin.com/2010/10/20/vmware-data-recovery-status-report-script/
#
# CRON
# 15 7 * * 1-5 /root/vDRreport.sh
#
# Variables
domain=smt.de
host=$HOSTNAME
smtphost=yourmailhost
mailto=dasi@smt.de
#
cat /dev/null >> /root/olderror.out
cat /dev/null >> /root/oldsuccess.out
err=0
succ=0
#
# List all Errors
strings -e l /var/vmware/datarecovery/operations_log.utx | grep -i -B2 "error" | awk -F"$" '{print substr($2,5,21) " " substr($2, 27, 100) " " $3 " " substr($6,17,20)}' > /root/newerror.out
#
# List all Successes
strings -e l /var/vmware/datarecovery/operations_log.utx | grep -i -B1 "success" | awk -F"$" '{print substr($2,5,21) " " substr($2, 26, 100) " " substr($3,5,100)}' > /root/newsuccess.out
##
# Compare new list of all errors to old list of all errors
if ! diff /root/olderror.out /root/newerror.out
then
diff /root/olderror.out /root/newerror.out | grep ">" > /root/differr.out
err=$(cat /root/differr.out | grep -c "error")
echo Failed Jobs - $err
mv /root/newerror.out /root/olderror.out -f
fi
#
if ! diff /root/oldsuccess.out /root/newsuccess.out
then
diff /root/oldsuccess.out /root/newsuccess.out | grep ">" > /root/diffsuccess.out
succ=$(cat /root/diffsuccess.out | grep -c "success")
echo Successful Jobs - $succ
mv /root/newsuccess.out /root/oldsuccess.out -f
fi
# Send email with any errors found
(
sleep 1
echo "HELO $host.$domain"
sleep 1
echo "mail from: vdrreport@$domain"
sleep 1
echo "rcpt to:$mailto"
sleep 1
echo "data"
sleep 1
echo "subject: VDR-Report - $host $(date +"%Y-%m-%d %H:%M") Jobs OK: $succ, FAILED: $err"
sleep 1
echo "from: VMWare Data Recovery on "$host
sleep 1
echo "to:$mailto"
sleep 1
echo ""
sleep 1
echo ""
sleep 1
echo "$host $(date +"%Y-%m-%d %H:%M") Jobs OK:$succ, FAILED:$err "
echo ""
sleep 1
echo "##### Successful Jobs ($succ) #####"
sleep 1
echo ""
sleep 1
if [ -f /root/diffsuccess.out ]
then
cat /root/diffsuccess.out
else
echo No successful jobs listed!
fi
sleep 1
echo ""
sleep 1
echo ""
sleep 1
echo "##### Failed Jobs ($err) #####"
sleep 1
echo " "
sleep 1
if [ -f /root/differr.out ]
then
cat /root/differr.out
else
echo No failed jobs!
fi
sleep 1
echo " "
sleep 1
echo "."
sleep 1
echo "QUIT"
) | telnet $smtphost 25

if [ -f /root/differr.out ]
then
rm -f /root/differr.out
fi

if [ -f /root/diffsuccess.out ]
then
rm -f /root/diffsuccess.out
fi

exit 0
